---
title: "Exploratory Data Analysis"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: "hide"
---

```{r setup, include = FALSE}
library(tidyverse)
library(readr)
library(plotly)

knitr::opts_chunk$set(
  warning = FALSE, 
  message = FALSE,
  fig.align = 'center')

theme_set(theme_minimal() + theme(legend.position = "bottom"))
```

## Data Sources and Overview 

The source of the dataset comes from R for Data Science's [Tidy Tuesday Project](https://github.com/rfordatascience/tidytuesday/tree/master/data/2021/2021-03-09), which provides weekly releases of raw datasets for users to wrangle and analyze. The data itself originates from FiveThirtyEight, containing movies ranging from 1970 to 2013, and merges data from several sources:

* **[IMDB](https://imdb.com)**: Provides information about each film, such as year, runtime, genres, accolades, fan and critic ratings.
* **[BechdelTest.com](http://bechdeltest.com)**: The site is operated by fans who analyze films and ascertain if they pass the Bechdel test. The site has detailed, coded information about the year, title, and a Bechdel Test score ranging from 0-3 (see [Data Cleaning](EDA.html#Data_cleaning) for further information about scoring).
* **[The-Numbers.com](https://The-Numbers.com)**: Provides financial information, including the budget and gross revenue of each movie.

## Data Import and Cleaning

```{r load}
raw_bechdel = read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-03-09/raw_bechdel.csv')

movies = read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-03-09/movies.csv')
```

The dataset was distributed in two files, `movies.csv`, `raw_bechdel.csv`.

* `movies.csv`: A data file of `r nrow(movies)` observations and `r ncol(movies)` variables, which includes movies from 1970 to 2013, and contains variables for title, IMDB ID, year, Bechdel test (uncleaned, cleaned, binary pass/fail), genres, ratings, budget, domestic and international gross revenue, and 2013-adjusted budget and revenues.
* `raw_bechdel.csv`: A data file of `r nrow(raw_bechdel)` observations and `r ncol(raw_bechdel)` variables, containing movies from 1888 to 2021, and contains variables for title, movie ID, IMDB ID, and raw Bechdel test score (0 to 3).

### Data cleaning

The data cleaning steps involve the following:

- Converting character to numeric variables for `domgross`, `intgross`, `domgross_2013`, `intgross_2013`, and `runtime`
- Converting the `binary` character variable to a logical variable `pass_bechdel` that indicates whether the movie passes or fails the Bechdel Test
- Recoding and relevelling the numeric `decade_code` variable into a `decade` factor variable according to the decade of release
- Creating an `award_winner` variable that is `TRUE` if the movie has won at least 1 Oscar, Golden Globe, or BAFTA award
- Splitting the `genre` character variable into dummy-coded variables indicating whether the movie falls under one of 20 different genres
- Creating a `bechdel_score` categorical variable of 4 levels corresponding to the Bechdel Test criteria:
  - 0 = Less than 2 women
  - 1 = Women don't talk to each other
  - 2 = Women only talk about men
  - 3 = Dubious (Passes Bechdel Test, but is disputed)
  - 4 = Passes Bechdel Test
- Creating variables for profit and ROI for each movie, adjusted to 2013 inflation. For this, we will use worldwide box office revenue instead of domestic revenue.
  - `profit` = `intgross_2013 – budget_2013`
  - `ROI` = `profit / budget_2013`
- Renaming key variables to relevant names


```{r tidy movies}
movies_df = movies %>% 
  mutate(test = as.factor(test), 
         clean_test = fct_recode(clean_test, 
                                 "Less than 2 women" = "nowomen", 
                                 "Don't talk to each other" = "notalk",
                                 "Only talk about men" = "men", 
                                 "Dubious" = "dubious",
                                 "Passes Bechdel" = "ok"),
         clean_test = fct_relevel(clean_test, c("Less than 2 women", "Don't talk to each other", 
                                                "Only talk about men", "Dubious", "Passes Bechdel")),
         binary = ifelse(clean_test == "Dubious" | clean_test == "Passes Bechdel", TRUE, FALSE), 
         domgross = as.numeric(domgross),
         intgross = as.numeric(intgross),
         domgross_2013 = as.numeric(domgross_2013),
         intgross_2013 = as.numeric(intgross_2013),
         decade_code = case_when(year >= 1970 & year < 1980 ~ "1970-1979",
                            year >= 1980 & year < 1990 ~ "1980-1989",
                            year >= 1990 & year < 2000 ~ "1990-1999",
                            year >= 2000 & year < 2010 ~ "2000-2009",
                            year >= 2010 & year < 2020 ~ "2010-2013"),
         decade_code = as.factor(decade_code),
         title = str_replace(title, "&#39;", "'"),
         title = str_replace(title, "&amp;", "&"),
         title = str_replace(title, "&agrave;", "à"),
         title = str_replace(title, "&aring;", "å"),
         title = str_replace(title, "&auml;", "ä"), 
         runtime = as.numeric(str_replace(runtime, " min", "")),
         award_winner = ifelse(str_detect(awards, "Won") & (str_detect(awards, "Golden Globe") | 
                                                              str_detect(awards, "Oscar") | str_detect(awards, "BAFTA")), T, F), 
         profit = intgross_2013 - budget_2013,
         ROI = profit/budget_2013) %>% 
  separate(genre, into = c("g1", "g2", "g3"), sep = ", ") %>% 
  rename("pass_bechdel" = binary,
         "bechdel_score" = clean_test,
         "decade" = decade_code) %>% 
  mutate(
    action = ifelse(g1 == "Action" | g2 == "Action" | g3 == "Action", TRUE, FALSE),
    adventure = ifelse(g1 == "Adventure" | g2 == "Adventure" | g3 == "Adventure", TRUE, FALSE),
    animation = ifelse(g1 == "Animation" | g2 == "Animation" | g3 == "Animation", TRUE, FALSE),
    biography = ifelse(g1 == "Biography" | g2 == "Biography" | g3 == "Biography", TRUE, FALSE),
    comedy = ifelse(g1 == "Comedy" | g2 == "Comedy" | g3 == "Comedy", TRUE, FALSE),
    crime = ifelse(g1 == "Crime" | g2 == "Crime" | g3 == "Crime", TRUE, FALSE),
    documentary = ifelse(g1 == "Documentary" | g2 == "Documentary" | g3 == "Documentary", TRUE, FALSE),
    drama = ifelse(g1 == "Drama" | g2 == "Drama" | g3 == "Drama", TRUE, FALSE),
    family = ifelse(g1 == "Family" | g2 == "Family" | g3 == "Family", TRUE, FALSE),
    fantasy = ifelse(g1 == "Fantasy" | g2 == "Fantasy" | g3 == "Fantasy", TRUE, FALSE),
    history = ifelse(g1 == "History" | g2 == "History" | g3 == "History", TRUE, FALSE),
    horror = ifelse(g1 == "Horror" | g2 == "Horror" | g3 == "Horror", TRUE, FALSE),
    music = ifelse(g1 == "Music" | g2 == "Music" | g3 == "Music", TRUE, FALSE),
    musical = ifelse(g1 == "Musical" | g2 == "Musical" | g3 == "Musical", TRUE, FALSE),
    mystery = ifelse(g1 == "Mystery" | g2 == "Mystery" | g3 == "Mystery", TRUE, FALSE),
    romance = ifelse(g1 == "Romance" | g2 == "Romance" | g3 == "Romance", TRUE, FALSE),
    sci_fi = ifelse(g1 == "Sci-Fi" | g2 == "Sci-Fi" | g3 == "Sci-Fi", TRUE, FALSE),
    sport = ifelse(g1 == "Sport" | g2 == "Sport" | g3 == "Sport", TRUE, FALSE),
    thriller = ifelse(g1 == "Thriller" | g2 == "Thriller" | g3 == "Thriller", TRUE, FALSE),
    war = ifelse(g1 == "War" | g2 == "War" | g3 == "War", TRUE, FALSE),
    western = ifelse(g1 == "Western" | g2 == "Western" | g3 == "Western", TRUE, FALSE)
  ) %>% 
  mutate(across(action:western, ~replace_na(., FALSE))) %>%
  select(year, title, bechdel_score, pass_bechdel, budget_2013:intgross_2013, decade, imdb_id, metascore, imdb_rating, award_winner, runtime, profit, ROI, action:western) 

readr::write_csv(movies_df, "./movies_df.csv")

movies_df %>% 
  kableExtra::kbl() %>% 
  kableExtra::kable_paper("striped", "hover", full_width = F) %>% 
  kableExtra::scroll_box(width = "100%", height = "300px")
```

  
   
Our resulting dataset contains `r nrow(movies_df)` observations and `r ncol(movies_df)` variables, providing information about the movie's decade, genre, and runtime, whether it passes the Bechdel Test Score, a binary Bechdel Test variable, and information about its budget, revenue, and ratings.

## Exploratory Data Analysis

Now that we have our tidied dataset, we can conduct some exploratory analyses to answer the 3 following questions:

* How has the distribution of movies that pass the Bechdel Test changed over time?
* How do movies who pass differing levels of each Bechdel Test vary in terms of their budget?
* How do movies who pass differing levels of each Bechdel Test vary in terms of their revenue (profit and ROI)?
* Do movies that pass vs. fail the Bechdel Test differ in terms of fan or critic ratings?

### Distribution of Bechdel Test Scores

First, we want to examine the distribution of movies according to Bechdel Test dimension. The code chunk below summarizes the proportion of movies in `movies_df` according to their Bechdel Test Score, as well as the proportion of movies that pass or fail the Bechdel test.

```{r bechdel distribution}
movies_df %>% 
  group_by(pass_bechdel) %>% 
  summarise(N = n()) %>% 
  mutate(Proportion = N/sum(N)) %>% 
  rename("Passes Bechdel Test" = pass_bechdel) %>% 
  knitr::kable(digits = 3) %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"))

movies_df %>% 
  group_by(bechdel_score) %>% 
  summarise(N = n()) %>% 
  mutate(Proportion = N/sum(N)) %>% 
  rename("Bechdel Test Criterion" = bechdel_score) %>% 
  knitr::kable(digits = 3) %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"))
```

The tables indicate slightly over half of the movies in the data pass the Bechdel Test, with 52.7% of movies passing and 47.3% of movies failing. Examining these categories in more detail, we can see that among those movies that don't pass the Bechdel Test, most movies have women that don't talk to each other. Among movies that pass the Bechdel Test, we can see only a small proportion of these movies have a "dubious" or debatable pass. 

### Bechdel Test Scores by decade

Next, we want to explore whether the number of movies passing the Bechdel Test have increased over time. The code chunk below plots the distribution of movies according to their Bechdel score by decade.

```{r decades}
seventies_df = movies_df %>% 
  filter(decade == "1970-1979") %>% 
  group_by(decade, bechdel_score) %>% 
  summarise(N = n()) %>% 
  mutate(Proportion = N/sum(N))

eighties_df = movies_df %>% 
  filter(decade == "1980-1989") %>% 
  group_by(decade, bechdel_score) %>% 
  summarise(N = n()) %>% 
  mutate(Proportion = N/sum(N)) 

nineties_df = movies_df %>% 
  filter(decade == "1990-1999") %>% 
  group_by(decade, bechdel_score) %>% 
  summarise(N = n()) %>% 
  mutate(Proportion = N/sum(N))

thousands_df = movies_df %>% 
  filter(decade == "2000-2009") %>% 
  group_by(decade, bechdel_score) %>% 
  summarise(N = n()) %>% 
  mutate(Proportion = N/sum(N))

tens_df = movies_df %>% 
  filter(decade == "2010-2013") %>% 
  group_by(decade, bechdel_score) %>%  
  summarise(N = n()) %>%
  mutate(Proportion = N/sum(N))

decades = bind_rows(seventies_df, eighties_df, nineties_df, thousands_df, tens_df)

decades %>% 
  plot_ly(x = ~decade, y = ~Proportion*100, type = "bar", color = ~bechdel_score, colors = "RdYlGn") %>% 
  layout(barmode = "stack",
         title = "Distribution of movies passing Bechdel Test Criteria by decade",
         xaxis = list(title = "Decade"),
         yaxis = list(title = "Percentage (%)"))
```

This chart shows the breakdown of our sample of films stratified by decade. Looking at the resulting plot, we found that since 1970, an increasing proportion of movies pass the Bechdel Test, however this level has seemed to plateau since the 2000's. This may attributed to a smaller sample of films in the 2010s, due to the dataset only containing movies up to 2013. Despite this, the proportion of movies that decisively pass the Bechdel Test ('Dubious' means contributors were skeptical about whether the films in question passed the test) remains under 50%.

### Distribution of budgets according to Bechdel criteria

Next, we want to explore how movie budgets may vary according to the primacy of women's roles in movies. Grouping by Bechdel Test score, we can compute the distribution of movie budget, adjusted to 2013 inflation. 

```{r budgets}
movies_df %>% 
  mutate(pass_bechdel = ifelse(pass_bechdel == TRUE, "Pass", "Fail")) %>% 
  plot_ly(x = ~budget_2013, y = ~pass_bechdel, type = "box", text = ~title, color = ~pass_bechdel, colors = c("red4", "green4")) %>% 
  layout(xaxis = list(title = "Movie budget ($)"),
         yaxis = list(title = "Bechdel Test"), 
         showlegend = FALSE)

movies_df %>% 
  plot_ly(x = ~budget_2013, y = ~bechdel_score, type = "box", text = ~title, color = ~bechdel_score, colors = c("darkred","orange1", "green4")) %>% 
  layout(xaxis = list(title = "Movie budget ($)"),
         yaxis = list(title = "Bechdel Criterion"),
         showlegend = FALSE, 
         title = "Movie budgets (2013-adjusted) stratified by Bechdel Test criteria")
```

This chart shows the range of movie budgets stratified by criteria of the Bechdel Test. Movies that pass the Bechdel Test  appear to have slightly smaller budgets than movies that don't pass when we stratify on a binary basis. Meanwhile, when stratifying by the categorical Bechdel score, the budgets are not significantly different from each other, however, it appears that the interquartile range for movies that firmly pass the Bechdel Test is slightly lower than movies that don't firmly pass the Bechdel Test. These numbers may suggest that Hollywood puts more money behind male-only films than films in which women talk to each other, however, this will be further explored in subsequent analyses

### Distribution of revenue according to Bechdel criteria

Additionally, we want to explore how movie revenues may vary according to the primacy of women's roles in movies. We can examine this using the `profit` and `ROI` variables in our data. 


#### Profits

Starting with `profit`, which is the difference between `intgross_2013` (2013-adjusted international gross revenue) and `budget_2013` (2013-adjusted budget), we can plot the range of profits for each movie, stratified by their Bechdel Test criteria.  

```{r profits}
movies_df %>% 
  mutate(pass_bechdel = ifelse(pass_bechdel == TRUE, "Pass", "Fail")) %>% 
  plot_ly(x = ~profit, y = ~pass_bechdel, type = "box", text = ~title, color = ~bechdel_score, colors = c("darkred","orange1", "green4")) %>% 
  layout(boxmode = "group", 
         xaxis = list(title = "Profit ($)"),
         yaxis = list(title = "Bechdel Criterion"),
         showlegend = FALSE,
         title = "Movie profits stratified by Bechdel Test criteria")
```

Looking at the resulting plot, we see that the distribution of profits between movies passing vs. failing the Bechdel test are quite similar, with movies that fail the Bechdel Test reeling in slightly higher profits. The profits overall appear quite right-skewed, with some outliers bringing in similar amounts of profit (e.g. Star Wars and the Titanic). When we stratify further by each dimension of the Bechdel Test, there are no notable differences in the profits between Bechdel criteria. 

#### ROI

Next, let's examine `ROI`, which is the ratio of `profit` to `budget_2013`. Because ROI is heavily right-skewed, we will log-transform this variable to better visualize differences in the ROI distribution between movies of differing Bechdel criteria. 

```{r roi}
movies_df %>% 
  mutate(pass_bechdel = ifelse(pass_bechdel == TRUE, "Pass", "Fail")) %>% 
  plot_ly(x = ~log(ROI), y = ~pass_bechdel, type = "box", text = ~title, color = ~bechdel_score, colors = c("darkred","orange1", "green4")) %>% 
  layout(boxmode = "group", 
         xaxis = list(title = "Log(Return on Investment)"),
         yaxis = list(title = "Bechdel Criterion"),
         showlegend = FALSE,
         title = "Movie ROI stratified by Bechdel Test criteria")
```

Examining the `log(ROI)` across Bechdel dimensions, the range of financial performance does not appear to differ substantially, as the median and IQR are approximately the same across all categories. Therefore, despite having slightly lower budgets, we can see that the primacy of women's roles in movies do not negatively impact movies' financial performance, and therefore refutes claims that films with stronger female characters perform any worse at the box office than films without them.

### Bechdel Test by IMDB Rating

Although financial performance is an important indicator of success for films, we may also want to consider how well movies are received by fans and critics depending on the primacy of female roles. We can plot IMDB ratings (fan ratings) against Metacritic Scores (aggregate scores based on critic reviews) and stratify by Bechdel Score.

```{r ratings}
movies_df %>% 
  plot_ly(x = ~imdb_rating, y = ~metascore/10, color = ~bechdel_score, type = "scatter", 
          mode = "markers", colors = c("darkred","orange1", "green4"), text = ~title, alpha = 0.6) %>% 
  layout(yaxis = list(title = list(text = "Metascore", standoff = 5), gridcolor = "lightgray"),
         xaxis = list(title = "IMDB Rating"), gridcolor = "gray",
         title = "Movie IMDB and Metacritic Scores stratified by Bechdel Test criteria")
```

Based on the scatterplot, we do not see any discernable clusters that indicate movies that pass the Bechdel test perform better or worse than movies that do not pass the Bechdel Test. However, we do notice that there films with high outlying fan and critic scores appear to fail the Bechdel Test. Additionally, we see that there are more films passing the Bechdel Test with higher critic ratings relative to fan ratings, and more films that fail the Bechdel Test with lower critic ratings relative to fan ratings. This could perhaps be inherent biases held by fans to be more critical of films with female-dominant roles, while critics may be more likely to isolate their own biases while judging films.


### Tests of association

Here I run some tests of association between `bechdel_score` and outcome variables. I run a Kruskal-Walllis test to account for the distribution of outcomes that are not normal.

```{r}
kruskal.test(imdb_rating ~ bechdel_score, data = movies_df) %>% 
  broom::tidy() %>% 
  rename("Test statistic" = statistic,
         "p-value" = p.value, 
         "Parameter (df)" = parameter,
         "Method" = method) %>% 
  kableExtra::kbl() %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover")) %>%
  kableExtra::kable_styling(font_size = 12)

kruskal.test(metascore ~ bechdel_score, data = movies_df) %>% 
  broom::tidy() %>% 
  rename("Test statistic" = statistic,
         "p-value" = p.value, 
         "Parameter (df)" = parameter,
         "Method" = method) %>% 
  kableExtra::kbl() %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover")) %>%
  kableExtra::kable_styling(font_size = 12)

kruskal.test(budget_2013 ~ bechdel_score, data = movies_df) %>% 
  broom::tidy() %>% 
  rename("Test statistic" = statistic,
         "p-value" = p.value, 
         "Parameter (df)" = parameter,
         "Method" = method) %>% 
  kableExtra::kbl() %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover")) %>%
  kableExtra::kable_styling(font_size = 12)

kruskal.test(profit ~ bechdel_score, data = movies_df) %>% 
  broom::tidy() %>% 
  rename("Test statistic" = statistic,
         "p-value" = p.value, 
         "Parameter (df)" = parameter,
         "Method" = method) %>% 
  kableExtra::kbl() %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover")) %>%
  kableExtra::kable_styling(font_size = 12)

kruskal.test(ROI ~ bechdel_score, data = movies_df) %>% 
  broom::tidy() %>% 
  rename("Test statistic" = statistic,
         "p-value" = p.value, 
         "Parameter (df)" = parameter,
         "Method" = method) %>% 
  kableExtra::kbl() %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover")) %>%
  kableExtra::kable_styling(font_size = 12)

```

