---
title: "Exploratory Data Analysis"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: "hide"
date: "2022-12-05"
---

```{r setup, include = FALSE}
library(tidyverse)
library(readr)
library(plotly)

knitr::opts_chunk$set(
  warning = FALSE, 
  message = FALSE,
  fig.align = 'center')

theme_set(theme_minimal() + theme(legend.position = "bottom"))
```

## Data Sources and Overview 

The source of the dataset comes from R for Data Science's [Tidy Tuesday Project](https://github.com/rfordatascience/tidytuesday/tree/master/data/2021/2021-03-09), which provides weekly releases of raw datasets for users to wrangle and analyze. The data itself originates from FiveThirtyEight, containing movies ranging from 1970 to 2013, and merges data from several sources:

* **[IMDB](https://imdb.com)**: Provides information about each film, such as year, runtime, genres, accolades, fan and critic ratings.
* **[BechdelTest.com](http://bechdeltest.com)**: The site is operated by fans who analyze films and ascertain if they pass the Bechdel test. The site has detailed, coded information about the year, title, and a Bechdel Test score ranging from 0-3 (see [Data Cleaning](EDA.html#Data_cleaning) for further information about scoring).
* **[The-Numbers.com](https://The-Numbers.com)**: Provides financial information, including the budget and gross revenue of each movie.

## Data Import and Cleaning

```{r load}
raw_bechdel = read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-03-09/raw_bechdel.csv')

movies = read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-03-09/movies.csv')
```

The dataset was distributed in two files, `movies.csv`, `raw_bechdel.csv`.

* `movies.csv`: A data file of `r nrow(movies)` observations and `r ncol(movies)` variables, which includes movies from 1970 to 2013, and contains variables for title, IMDB ID, year, Bechdel test (uncleaned, cleaned, binary pass/fail), genres, ratings, budget, domestic and international gross revenue, and 2013-adjusted budget and revenues.
* `raw_bechdel.csv`: A data file of `r nrow(raw_bechdel)` observations and `r ncol(raw_bechdel)` variables, containing movies from 1888 to 2021, and contains variables for title, movie ID, IMDB ID, and raw Bechdel test score (0 to 3).

### Data cleaning

The data cleaning steps involve the following:

- Converting character to numeric variables for `domgross`, `intgross`, `domgross_2013`, `intgross_2013`, and `runtime`
- Converting the `binary` character variable to a logical variable `pass_bechdel` that indicates whether the movie passes or fails the Bechdel Test
- Recoding and relevelling the numeric `decade_code` variable into a `decade` factor variable according to the decade of release
- Creating an `award_winner` variable that is `TRUE` if the movie has won at least 1 Oscar, Golden Globe, or BAFTA award
- Splitting the `genre` character variable into dummy-coded variables indicating whether the movie falls under one of 20 different genres
- Creating a `bechdel_score` categorical variable of 4 levels corresponding to the Bechdel Test criteria:
  - 0 = Less than 2 women
  - 1 = Women don't talk to each other
  - 2 = Women only talk about men
  - 3 = Dubious (Passes Bechdel Test, but is disputed)
  - 4 = Passes Bechdel Test
- Creating variables for profit and ROI for each movie, adjusted to 2013 inflation. For this, we will use worldwide box office revenue instead of domestic revenue.
  - `profit` = `intgross_2013 – budget_2013`
  - `ROI` = `profit / budget_2013`
- Renaming key variables to relevant names


```{r tidy movies}
movies_df = movies %>% 
  mutate(test = as.factor(test), 
         clean_test = fct_recode(clean_test, 
                                 "Less than 2 women" = "nowomen", 
                                 "Don't talk to each other" = "notalk",
                                 "Only talk about men" = "men", 
                                 "Dubious" = "dubious",
                                 "Passes Bechdel" = "ok"),
         clean_test = fct_relevel(clean_test, c("Less than 2 women", "Don't talk to each other", 
                                                "Only talk about men", "Dubious", "Passes Bechdel")),
         binary = ifelse(clean_test == "Dubious" | clean_test == "Passes Bechdel", TRUE, FALSE), 
         domgross = as.numeric(domgross),
         intgross = as.numeric(intgross),
         domgross_2013 = as.numeric(domgross_2013),
         intgross_2013 = as.numeric(intgross_2013),
         decade_code = case_when(year >= 1970 & year < 1980 ~ "1970-1979",
                            year >= 1980 & year < 1990 ~ "1980-1989",
                            year >= 1990 & year < 2000 ~ "1990-1999",
                            year >= 2000 & year < 2010 ~ "2000-2009",
                            year >= 2010 & year < 2020 ~ "2010-2013"),
         decade_code = as.factor(decade_code),
         title = str_replace(title, "&#39;", "'"),
         title = str_replace(title, "&amp;", "&"),
         title = str_replace(title, "&agrave;", "à"),
         title = str_replace(title, "&aring;", "å"),
         title = str_replace(title, "&auml;", "ä"), 
         runtime = as.numeric(str_replace(runtime, " min", "")),
         award_winner = ifelse(str_detect(awards, "Won") & (str_detect(awards, "Golden Globe") | 
                                                              str_detect(awards, "Oscar") | str_detect(awards, "BAFTA")), T, F), 
         profit = intgross_2013 - budget_2013,
         ROI = profit/budget_2013) %>% 
  separate(genre, into = c("g1", "g2", "g3"), sep = ", ") %>% 
  rename("pass_bechdel" = binary,
         "bechdel_score" = clean_test,
         "decade" = decade_code) %>% 
  mutate(
    action = ifelse(g1 == "Action" | g1 == "Action" | g1 == "Action", TRUE, FALSE),
    adventure = ifelse(g1 == "Adventure" | g1 == "Adventure" | g1 == "Adventure", TRUE, FALSE),
    animation = ifelse(g1 == "Animation" | g1 == "Animation" | g1 == "Animation", TRUE, FALSE),
    biography = ifelse(g1 == "Biography" | g1 == "Biography" | g1 == "Biography", TRUE, FALSE),
    comedy = ifelse(g1 == "Comedy" | g1 == "Comedy" | g1 == "Comedy", TRUE, FALSE),
    crime = ifelse(g1 == "Crime" | g1 == "Crime" | g1 == "Crime", TRUE, FALSE),
    documentary = ifelse(g1 == "Documentary" | g1 == "Documentary" | g1 == "Documentary", TRUE, FALSE),
    drama = ifelse(g1 == "Drama" | g1 == "Drama" | g1 == "Drama", TRUE, FALSE),
    family = ifelse(g1 == "Family" | g1 == "Family" | g1 == "Family", TRUE, FALSE),
    fantasy = ifelse(g1 == "Fantasy" | g1 == "Fantasy" | g1 == "Fantasy", TRUE, FALSE),
    history = ifelse(g1 == "History" | g1 == "History" | g1 == "History", TRUE, FALSE),
    horror = ifelse(g1 == "Horror" | g1 == "Horror" | g1 == "Horror", TRUE, FALSE),
    music = ifelse(g1 == "Music" | g1 == "Music" | g1 == "Music", TRUE, FALSE),
    musical = ifelse(g1 == "Musical" | g1 == "Musical" | g1 == "Musical", TRUE, FALSE),
    mystery = ifelse(g1 == "Mystery" | g1 == "Mystery" | g1 == "Mystery", TRUE, FALSE),
    romance = ifelse(g1 == "Romance" | g1 == "Romance" | g1 == "Romance", TRUE, FALSE),
    sci_fi = ifelse(g1 == "Sci-Fi" | g1 == "Sci-Fi" | g1 == "Sci-Fi", TRUE, FALSE),
    sport = ifelse(g1 == "Sport" | g1 == "Sport" | g1 == "Sport", TRUE, FALSE),
    thriller = ifelse(g1 == "Thriller" | g1 == "Thriller" | g1 == "Thriller", TRUE, FALSE),
    war = ifelse(g1 == "War" | g1 == "War" | g1 == "War", TRUE, FALSE),
    western = ifelse(g1 == "Western" | g1 == "Western" | g1 == "Western", TRUE, FALSE)
  ) %>% 
  select(year, title, bechdel_score, pass_bechdel, budget_2013:intgross_2013, decade, imdb_id, metascore, imdb_rating, award_winner, runtime, profit, ROI, action:western) 

readr::write_csv(movies_df, "./movies_df.csv")

movies_df %>% 
  kableExtra::kbl() %>% 
  kableExtra::kable_paper("striped", "hover", full_width = F) %>% 
  kableExtra::scroll_box(width = "100%", height = "300px")
```

\ 
Our resulting dataset contains `r nrow(movies_df)` observations and `r ncol(movies_df)` variables, providing information about the movie's decade, genre, and runtime, whether it passes the Bechdel Test Score, a binary Bechdel Test variable, and information about its budget, revenue, and ratings.

## Exploratory Data Analysis

### Distribution of Bechdel Test Scores

First, we want to examine the distribution of movies according to Bechdel Test dimension. The code chunk below summarizes the proportion of movies in `movies_df` according to their Bechdel Test Score, as well as the proportion of movies that pass or fail the Bechdel test.

```{r bechdel distribution}
movies_df %>% 
  group_by(pass_bechdel) %>% 
  summarise(N = n()) %>% 
  mutate(Proportion = N/sum(N)) %>% 
  rename("Passes Bechdel Test" = pass_bechdel) %>% 
  knitr::kable(digits = 3) %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"))

movies_df %>% 
  group_by(bechdel_score) %>% 
  summarise(N = n()) %>% 
  mutate(Proportion = N/sum(N)) %>% 
  rename("Bechdel Test Criterion" = bechdel_score) %>% 
  knitr::kable(digits = 3) %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"))
```

The tables indicate slightly over half of the movies in the data pass the Bechdel Test, with 52.7% of movies passing and 47.3% of movies failing. Examining these categories in more detail, we can see that among those movies that don't pass the Bechdel Test, most movies have women that don't talk to each other. Among movies that pass the Bechdel Test, we can see only a small proportion of these movies have a "dubious" or debatable pass. 

### Bechdel Test Scores by decade

Next, we want to explore whether the number of movies passing the Bechdel Test have increased over time. The code chunk below plots the distribution of movies according to their Bechdel score by decade.

```{r proportions}
seventies_df = movies_df %>% 
  filter(decade == "1970-1979") %>% 
  group_by(decade, bechdel_score) %>% 
  summarise(N = n()) %>% 
  mutate(Proportion = N/sum(N))

eighties_df = movies_df %>% 
  filter(decade == "1980-1989") %>% 
  group_by(decade, bechdel_score) %>% 
  summarise(N = n()) %>% 
  mutate(Proportion = N/sum(N)) 

nineties_df = movies_df %>% 
  filter(decade == "1990-1999") %>% 
  group_by(decade, bechdel_score) %>% 
  summarise(N = n()) %>% 
  mutate(Proportion = N/sum(N))

thousands_df = movies_df %>% 
  filter(decade == "2000-2009") %>% 
  group_by(decade, bechdel_score) %>% 
  summarise(N = n()) %>% 
  mutate(Proportion = N/sum(N))

tens_df = movies_df %>% 
  filter(decade == "2010-2013") %>% 
  group_by(decade, bechdel_score) %>%  
  summarise(N = n()) %>%
  mutate(Proportion = N/sum(N))

decades = bind_rows(seventies_df, eighties_df, nineties_df, thousands_df, tens_df)

decades %>% 
  plot_ly(x = ~decade, y = ~Proportion*100, type = "bar", color = ~bechdel_score, colors = "RdYlGn") %>% 
  layout(barmode = "stack",
         title = "Distribution of movies passing Bechdel Test Criteria by decade",
         xaxis = list(title = "Decade"),
         yaxis = list(title = "Percentage (%)"))
```

This chart shows the breakdown of our sample of films stratified by decade. Looking at the resulting plot, we found that since 1970, an increasing proportion of movies pass the Bechdel Test, however this level has seemed to plateau since the 2000's. This may attributed to a smaller sample of films in the 2010s, due to the dataset only containing movies up to 2013. Despite this, the proportion of movies that decisively pass the Bechdel Test ('Dubious' means contributors were skeptical about whether the films in question passed the test) remains under 50%.

### Distribution of budgets according to Bechdel criteria

Next, we want to explore how movie budgets may vary according to the primacy of women's roles in movies. Grouping by Bechdel Test score, we can compute the distribution of movie budget, adjusted to 2013 inflation. 

```{r budgets}
movies_df %>% 
  plot_ly(x = ~pass_bechdel, y = ~budget_2013, type = "box", text = ~title, color = ~pass_bechdel, colors = c("red4", "green4")) %>% 
  layout(yaxis = list(title = "Movie budget ($)", standoff = 10),
         xaxis = list(title = "Passes Bechdel"))

movies_df %>% 
  plot_ly(x = ~bechdel_score, y = ~budget_2013, type = "box", text = ~title, color = ~bechdel_score, colors = c("darkred","orange1", "green4")) %>% 
  layout(yaxis = list(title = "Movie budget ($)", standoff = 10),
         xaxis = list(title = "Bechdel Criterion"))
```

This chart shows the range of movie budgets stratified by whether they pass certain criteria of the Bechdel Test. Movies that pass the Bechdel Test also appear to have slightly smaller budgets than movies that don't pass when we stratify on a binary basis. Meanwhile, when stratifying by the categorical Bechdel score, the budgets are not significantly different from each other, however, it appears that the interquartile range for movies that firmly pass the Bechdel Test is slightly lower than movies that don't firmly pass the Bechdel Test. 

### Distribution of revenue according to Bechdel criteria

```{r profits}
movies_df %>% 
  plot_ly(x = ~bechdel_score, y = ~profit, type = "box", text = ~title, color = ~bechdel_score, colors = c("darkred","orange1", "green4")) %>% 
  layout(yaxis = list(title = "Profit ($)", standoff = 10),
         xaxis = list(title = "Passes Bechdel"))

movies_df %>% 
  plot_ly(x = ~bechdel_score, y = ~ROI, type = "box", text = ~title, color = ~bechdel_score, colors = c("darkred","orange1", "green4")) %>% 
  layout(yaxis = list(title = "ROI ($)", standoff = 10),
         xaxis = list(title = "Bechdel Criterion"))
```


### Bechdel Test by IMDB Rating

```{r}
movies_df %>% 
  plot_ly(x = ~imdb_rating, y = ~metascore, color = ~bechdel_score, type = "scatter", 
          mode = "markers", colors = "RdYlGn") %>% 
  layout(yaxis = list(title = list(text = "metascore", standoff = 5), tickfont = list(size = 10), gridcolor = "white"),
         xaxis = list(title = "IMDB Rating"), tickfont = list(size = 10), gridcolor = "gray")
```




Next steps...

- F-test (ANOVA) of differences in budget


```{r}
budget_dist_p = movies_df %>% ggplot(aes(x = budget_2013)) + geom_histogram(alpha = 0.8, color = "white") + 
  labs(
    x = "Count",
    y = "Budget ($, 2013-adjusted)",
    title = "Distribution of movie budgets")

ggplotly(budget_dist_p)
```

It appears that budget is heavily right-skewed. For this, we will need to run a Kruskal-Wallace test in place of an F-test. Below are the results:

```{r}
kruskal.test(budget_2013 ~ bechdel_score, data = movies_df) %>% 
  broom::tidy() %>% 
  rename("Test statistic" = statistic,
         "p-value" = p.value, 
         "Parameter (df)" = parameter,
         "Method" = method) %>% 
  kableExtra::kbl() %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover")) %>%
  kableExtra::kable_styling(font_size = 12)

```

```{r}

```

